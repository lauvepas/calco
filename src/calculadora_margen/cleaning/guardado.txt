import pandas as pd
from typing import Optional, List
from abc import ABC, abstractmethod

class BaseCleaner(ABC):
    """
    Clase base abstracta para operaciones de limpieza/transformación
    sobre un DataFrame de pandas.
    """
    def __init__(self, df: pd.DataFrame, parent_cleaner=None):
        self.df = df.copy()
        self._parent = parent_cleaner
        self._summary = {
            'initial_size': len(df),
            'final_size': len(df),
            'operations': []
        }

    def _add_to_summary(self, operation: str, details: dict):
        """Añade una operación al resumen."""
        self._summary['operations'].append({
            'operation': operation,
            'details': details
        })
        self._summary['final_size'] = len(self.df)
        if self._parent:
            self._parent._summary['final_size'] = len(self.df)

    def _print_concise_summary(self):
        """Imprime un resumen conciso de las operaciones realizadas."""
        print("\n=== RESUMEN DE LIMPIEZA ===")
        print(f"Tamaño inicial del DataFrame: {self._summary['initial_size']}")
        print("\nOperaciones realizadas:")
        for op in self._summary['operations']:
            print(f"\n  - {op['operation']}:")
            for key, value in op['details'].items():
                print(f"    {key}: {value}")
        print(f"\nTamaño final del DataFrame: {self._summary['final_size']}")
        print(f"Total filas modificadas/eliminadas: {self._summary['initial_size'] - self._summary['final_size']}")

    @property
    def columns_cleaner(self):
        return ColumnsCleaner(self.df, self)

    @property
    def rows_cleaner(self):
        return RowsCleaner(self.df, self)

    @property
    def data_cleaner(self):
        return DataCleaner(self.df, self)

    def get_df(self) -> pd.DataFrame:
        """Devuelve el DataFrame resultante tras las operaciones."""
        return self.df

class ColumnsCleaner(BaseCleaner):
    """
    Clase especializada en operaciones sobre columnas del DataFrame.
    """
    def keep_and_rename(self,
                       cols_to_keep: list[str],
                       rename_map: dict[str, str] = None
                      ) -> "ColumnsCleaner":
        """
        Conserva sólo las columnas en cols_to_keep y renómbralas según rename_map.
        """
        initial_cols = len(self.df.columns)
        
        if rename_map:
            invalid = set(rename_map) - set(cols_to_keep)
            if invalid:
                raise ValueError(f"Las claves {invalid} no están en cols_to_keep")

        self.df = (
            self.df
            .loc[:, cols_to_keep]
            .rename(columns=rename_map or {})
        )
        
        self._add_to_summary("Selección y renombrado de columnas", {
            "columnas_iniciales": initial_cols,
            "columnas_finales": len(self.df.columns),
            "columnas_conservadas": cols_to_keep,
            "columnas_renombradas": rename_map or {}
        })
        
        if self._parent:
            self._parent.df = self.df
        return self

class RowsCleaner(BaseCleaner):
    """
    Clase especializada en operaciones sobre filas del DataFrame.
    """
    def drop_duplicates(self,
                       subset: list[str] = None,
                       keep: str = 'first'
                      ) -> "RowsCleaner":
        """
        Elimina filas duplicadas.
        """
        initial_rows = len(self.df)
        self.df = self.df.drop_duplicates(subset=subset, keep=keep)
        
        self._add_to_summary("Eliminación de duplicados", {
            "filas_eliminadas": initial_rows - len(self.df),
            "columnas_consideradas": subset or "todas",
            "criterio": f"mantener_{keep}"
        })
        
        if self._parent:
            self._parent.df = self.df
        return self
    
    def drop_na(self,
                subset: list[str] = None
               ) -> "RowsCleaner":
        """
        Elimina filas que contienen valores NA en las columnas indicadas.
        """
        initial_rows = len(self.df)
        self.df = self.df.dropna(subset=subset)
        
        self._add_to_summary("Eliminación de valores NA", {
            "filas_eliminadas": initial_rows - len(self.df),
            "columnas_consideradas": subset or "todas"
        })
        
        if self._parent:
            self._parent.df = self.df
        return self

    def drop_duplicates_batch(self,
                            column: str = 'lote_interno'
                           ) -> "RowsCleaner":
        """
        Elimina duplicados en la columna especificada.
        """
        initial_rows = len(self.df)
        self.df = self.df.drop_duplicates(subset=[column], keep='last')
        
        self._add_to_summary("Eliminación de duplicados por lote", {
            "columna": column,
            "filas_eliminadas": initial_rows - len(self.df)
        })
        
        if self._parent:
            self._parent.df = self.df
        return self

class DataCleaner(BaseCleaner):
    """
    Clase especializada en operaciones de limpieza y transformación de datos.
    """
    def fix_numeric_format(self, cols: Optional[List[str]] = None) -> "DataCleaner":
        """
        Corrige el formato numérico en las columnas indicadas.
        """
        if cols is not None:
            for col in cols:
                self.df[col] = (
                    self.df[col]
                    .astype(str)
                    .str.replace('.', '', regex=False)
                    .str.replace(',', '.', regex=False)
                    .astype(float)
                )
            
            self._add_to_summary("Corrección de formato numérico", {
                "columnas_procesadas": cols
            })
            
        if self._parent:
            self._parent.df = self.df
        return self

    def to_upper(self) -> "DataCleaner":
        """
        Convierte a mayúsculas todos los valores no nulos del DataFrame.
        """
        columns_processed = []
        for column in self.df.columns:
            if self.df[column].dtype == 'object':
                self.df[column] = self.df[column].apply(
                    lambda x: x.upper() if pd.notna(x) else x
                )
                columns_processed.append(column)
        
        if columns_processed:
            self._add_to_summary("Conversión a mayúsculas", {
                "columnas_procesadas": columns_processed
            })
        
        if self._parent:
            self._parent.df = self.df
        return self

class DataFrameCleaner(BaseCleaner):
    """
    Clase fachada que proporciona acceso a todas las funcionalidades de limpieza.
    """
    def __init__(self, df: pd.DataFrame):
        super().__init__(df)
        
    def get_df(self) -> pd.DataFrame:
        """Devuelve el DataFrame resultante tras las operaciones y muestra el resumen."""
        self._print_concise_summary()
        return self.df
    




##########################################################################################################################






import pandas as pd
from typing import Optional, List
from abc import ABC, abstractmethod

class BaseCleaner(ABC):
    """
    Clase base abstracta para operaciones de limpieza/transformación
    sobre un DataFrame de pandas.
    """
    def __init__(self, df: pd.DataFrame, parent_cleaner=None):
        self.df = df.copy()
        self._parent = parent_cleaner

    @property
    def columns_cleaner(self):
        return ColumnsCleaner(self.df, self)

    @property
    def rows_cleaner(self):
        return RowsCleaner(self.df, self)

    @property
    def data_cleaner(self):
        return DataCleaner(self.df, self)

    def get_df(self) -> pd.DataFrame:
        """Devuelve el DataFrame resultante tras las operaciones."""
        return self.df

class ColumnsCleaner(BaseCleaner):
    """
    Clase especializada en operaciones sobre columnas del DataFrame.
    """
    def keep_and_rename(self,
                       cols_to_keep: list[str],
                       rename_map: dict[str, str] = None
                      ) -> "ColumnsCleaner":
        """
        Conserva sólo las columnas en cols_to_keep y renómbralas según rename_map.

        Parámetros
        ----------
        cols_to_keep : list[str]
            Lista de nombres de columnas a conservar.
        rename_map : dict[str, str], opcional
            Mapeo {columna_original: nuevo_nombre}. Las claves deben
            estar dentro de cols_to_keep.

        Retorna
        -------
        self : ColumnsCleaner
            La misma instancia, con self.df actualizada.            
        """
        if rename_map:
            invalid = set(rename_map) - set(cols_to_keep)
            if invalid:
                raise ValueError(f"Las claves {invalid} no están en cols_to_keep")

        self.df = (
            self.df
            .loc[:, cols_to_keep]
            .rename(columns=rename_map or {})
        )
        if self._parent:
            self._parent.df = self.df
        return self
    

class RowsCleaner(BaseCleaner):
    """
    Clase especializada en operaciones sobre filas del DataFrame.
    """
    def drop_duplicates(self,
                       subset: list[str] = None,
                       keep: str = 'first'
                      ) -> "RowsCleaner":
        """
        Elimina filas duplicadas.
        """
        self.df = self.df.drop_duplicates(subset=subset, keep=keep)
        if self._parent:
            self._parent.df = self.df
        return self
    
    def drop_na(self,
                subset: list[str] = None
               ) -> "RowsCleaner":
        """
        Elimina filas que contienen valores NA en las columnas indicadas.

        Parámetros
        ----------
        subset : list[str], opcional
            Columnas a considerar para identificar NA. Si es None,
            se consideran todas las columnas.

        Retorna
        -------
        self : RowsCleaner
            La misma instancia, con self.df actualizada.            
        """
        self.df = self.df.dropna(subset=subset)
        if self._parent:
            self._parent.df = self.df
        return self

    def drop_duplicates_batch(self,
                            column: str = 'lote_interno'
                           ) -> "RowsCleaner":
        """
        Elimina duplicados en la columna especificada, manteniendo la última aparición.
        Por defecto usamos lote_interno porque los duplicados se producen por actualizaciones 
        de precios. Entendemos que el correcto es el último.

        Parámetros
        ----------
        column : str
            Nombre de la columna donde buscar duplicados.
        
        Retorna
        -------
        self : RowsCleaner
            La misma instancia, con self.df actualizada.            
        """
        self.df = self.df.drop_duplicates(subset=[column], keep='last')
        if self._parent:
            self._parent.df = self.df
        return self

class DataCleaner(BaseCleaner):
    """
    Clase especializada en operaciones de limpieza y transformación de datos.
    """
    def fix_numeric_format(self, cols: Optional[List[str]] = None) -> "DataCleaner":
        """
        Corrige el formato numérico en las columnas indicadas:
        elimina puntos de miles y reemplaza comas por puntos,
        luego convierte a float.

        Parámetros
        ----------
        cols : list[str], opcional
            Lista de columnas cuyos valores numéricos están en formato string.
            Si es None, no se realiza ninguna conversión.

        Retorna
        -------
        self : DataCleaner
            La misma instancia, con self.df actualizada.
        """
        if cols is not None:
            for col in cols:
                self.df[col] = (
                    self.df[col]
                    .astype(str)
                    .str.replace('.', '', regex=False)
                    .str.replace(',', '.', regex=False)
                    .astype(float)
                )
        if self._parent:
            self._parent.df = self.df
        return self

    def to_upper(self) -> "DataCleaner":
        """
        Convierte a mayúsculas todos los valores no nulos del DataFrame.
        Preserva los valores nulos (NaN) para mantener la funcionalidad de pandas.

        Retorna
        -------
        self : DataCleaner
            La misma instancia, con self.df actualizada.            
        """
        for column in self.df.columns:
            if self.df[column].dtype == 'object':
                self.df[column] = self.df[column].apply(
                    lambda x: x.upper() if pd.notna(x) else x
                )
        if self._parent:
            self._parent.df = self.df
        return self

class DataFrameCleaner(BaseCleaner):
    """
    Clase fachada que proporciona acceso a todas las funcionalidades de limpieza.
    """
    def __init__(self, df: pd.DataFrame):
        super().__init__(df)
